<% test_suite = @test_case.test_suite %>
<% project = test_suite.project %>

<% content_for :page_title, "PROTOCOL: #{@test_case.title.upcase.truncate(40)}" %>

<% content_for :breadcrumbs do %>
  <%= link_to project.name, project_path(project), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <%= link_to test_suite.name, test_suite_path(test_suite), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <span class="text-text-muted">Protocol</span>
<% end %>

<!-- Classification Header -->
<div class="mb-6 px-4 py-3 bg-dark-surface border border-status-error/30 flex items-center justify-between">
  <div class="flex items-center space-x-4">
    <span class="text-[10px] font-mono text-status-error uppercase tracking-widest">Classified Protocol</span>
    <div class="h-3 w-px bg-status-error/30"></div>
    <span class="text-[10px] font-mono text-text-muted uppercase tracking-wider">Bank: <%= test_suite.name %></span>
  </div>
  <% if @test_case.cypress_id.present? %>
    <span class="text-[10px] font-mono text-primary uppercase tracking-wider">ID: <%= @test_case.cypress_id %></span>
  <% end %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Preconditions -->
    <% if @test_case.preconditions.present? %>
      <div class="panel">
        <div class="panel-header flex items-center space-x-3">
          <svg class="w-4 h-4 text-status-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          <span>PRECONDITIONS</span>
        </div>
        <div class="p-6">
          <p class="text-text-primary/80 font-mono text-sm whitespace-pre-wrap"><%= @test_case.preconditions %></p>
        </div>
      </div>
    <% end %>

    <!-- Steps -->
    <div class="panel">
      <div class="panel-header flex items-center space-x-3">
        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
        </svg>
        <span>EXECUTION STEPS</span>
      </div>
      <div class="p-6">
        <div class="text-text-primary/80 font-mono text-sm whitespace-pre-wrap space-y-2">
          <% @test_case.steps.to_s.split("\n").each_with_index do |step, index| %>
            <% next if step.strip.blank? %>
            <div class="flex items-start space-x-3 p-3 bg-dark-base/30 border-l-2 border-primary/50 hover:border-primary transition-colors">
              <span class="text-primary font-bold text-xs">[<%= format('%02d', index + 1) %>]</span>
              <span class="text-text-primary/80"><%= step %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Expected Result -->
    <div class="panel">
      <div class="panel-header flex items-center space-x-3">
        <svg class="w-4 h-4 text-status-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>EXPECTED OUTCOME</span>
      </div>
      <div class="p-6">
        <div class="p-4 bg-status-success/10 border border-status-success/30">
          <p class="text-status-success font-mono text-sm whitespace-pre-wrap"><%= @test_case.expected_result %></p>
        </div>
      </div>
    </div>

    <!-- Execution History -->
    <div class="panel">
      <div class="panel-header flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <svg class="w-4 h-4 text-status-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>EXECUTION HISTORY</span>
        </div>
        <span class="text-[10px] font-mono text-primary"><%= @execution_history.size %> Records</span>
      </div>
      <div class="p-4">
        <% if @execution_history.any? %>
          <%
            # Calculate stats
            total = @execution_history.size
            passed = @execution_history.select { |e| e.status == 'passed' }.size
            failed = @execution_history.select { |e| e.status == 'failed' }.size
            pass_rate = total > 0 ? ((passed.to_f / total) * 100).round : 0
          %>

          <!-- Stats Bar -->
          <div class="mb-4 flex items-center justify-between p-3 bg-dark-base/30 border border-primary/20">
            <div class="flex items-center space-x-4">
              <div class="text-center">
                <p class="text-lg font-mono font-bold text-primary"><%= total %></p>
                <p class="text-[9px] font-mono text-text-muted uppercase">Executions</p>
              </div>
              <div class="text-center">
                <p class="text-lg font-mono font-bold text-status-success"><%= passed %></p>
                <p class="text-[9px] font-mono text-text-muted uppercase">Nominal</p>
              </div>
              <div class="text-center">
                <p class="text-lg font-mono font-bold text-status-error"><%= failed %></p>
                <p class="text-[9px] font-mono text-text-muted uppercase">Breach</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-xl font-mono font-bold <%= pass_rate >= 80 ? 'text-status-success' : pass_rate >= 50 ? 'text-status-warning' : 'text-status-error' %>">
                <%= pass_rate %>%
              </p>
              <p class="text-[9px] font-mono text-text-muted uppercase">Pass Rate</p>
            </div>
          </div>

          <!-- History Timeline -->
          <div class="space-y-2 max-h-80 overflow-y-auto">
            <% @execution_history.each do |execution| %>
              <%
                status = execution.status || 'untested'
                status_color = case status
                when 'passed' then 'status-success'
                when 'failed' then 'status-error'
                when 'blocked' then 'status-warning'
                else 'text-muted'
                end
                status_label = case status
                when 'passed' then 'Passed'
                when 'failed' then 'Failed'
                when 'blocked' then 'BLOCKED'
                else 'Not Run'
                end
              %>
              <div class="flex items-center justify-between p-3 bg-dark-base/20 border-l-2 border-<%= status_color %>/50 hover:bg-dark-surface-mid/30 transition-colors group">
                <div class="flex items-center space-x-4">
                  <span class="w-2 h-2 rounded-full bg-<%= status_color %> <%= status == 'failed' ? 'animate-pulse' : '' %>"></span>
                  <div>
                    <%= link_to test_run_path(execution.test_run), class: "text-sm font-mono text-text-primary hover:text-primary transition-colors" do %>
                      <%= execution.test_run.name %>
                    <% end %>
                    <p class="text-[10px] font-mono text-text-muted">
                      by <%= execution.test_run.user.display_name %>
                    </p>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-[10px] font-mono text-<%= status_color %> uppercase tracking-wider"><%= status_label %></span>
                  <p class="text-[10px] font-mono text-text-muted"><%= execution.updated_at.strftime('%Y.%m.%d %H:%M') %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8">
            <svg class="w-12 h-12 mx-auto text-text-muted/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-sm font-mono text-text-muted uppercase tracking-wider">No execution history</p>
            <p class="text-[10px] font-mono text-text-muted/60 mt-1">This protocol has not been executed in any operation yet</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Protocol Info -->
    <div class="panel">
      <div class="panel-header">Protocol Parameters</div>
      <div class="p-4 space-y-4">
        <dl class="space-y-3 text-sm font-mono">
          <div class="flex justify-between">
            <dt class="text-text-muted uppercase text-[10px] tracking-wider">Mission</dt>
            <dd class="text-primary">
              <%= link_to project.name, project_path(project), class: "hover:text-primary/80" %>
            </dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-text-muted uppercase text-[10px] tracking-wider">Protocol Bank</dt>
            <dd class="text-primary">
              <%= link_to test_suite.name, test_suite_path(test_suite), class: "hover:text-primary/80" %>
            </dd>
          </div>
          <% if @test_case.cypress_id.present? %>
            <div class="flex justify-between">
              <dt class="text-text-muted uppercase text-[10px] tracking-wider">Automation ID</dt>
              <dd class="text-status-warning"><%= @test_case.cypress_id %></dd>
            </div>
          <% end %>
        </dl>

        <!-- Action Buttons -->
        <div class="pt-4 border-t border-status-error/20 space-y-2">
          <% if policy(@test_case).edit? %>
            <%= link_to edit_test_case_path(@test_case), class: "flex items-center justify-center w-full px-4 py-2 bg-dark-surface-mid border border-primary/30 text-primary text-xs font-mono uppercase tracking-wider hover:bg-primary/10 transition-colors" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Modify Protocol
            <% end %>
          <% end %>
          <% if policy(@test_case).destroy? %>
            <%= button_to test_case_path(@test_case), method: :delete, data: { confirm: 'PURGE PROTOCOL? This action cannot be undone.' }, class: "flex items-center justify-center w-full px-4 py-2 bg-status-error/10 border border-status-error/50 text-status-error text-xs font-mono uppercase tracking-wider hover:bg-status-error/20 transition-colors" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Purge Protocol
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="panel">
      <div class="panel-header">Navigation</div>
      <div class="p-4 space-y-1">
        <%= link_to test_suite_path(test_suite), class: "flex items-center px-3 py-2 text-text-primary/70 hover:text-primary hover:bg-dark-surface-mid transition-colors" do %>
          <svg class="w-4 h-4 mr-3 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          <span class="text-xs font-mono uppercase tracking-wider">Protocol Bank</span>
        <% end %>
        <%= link_to project_path(project), class: "flex items-center px-3 py-2 text-text-primary/70 hover:text-primary hover:bg-dark-surface-mid transition-colors" do %>
          <svg class="w-4 h-4 mr-3 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <span class="text-xs font-mono uppercase tracking-wider">Mission Overview</span>
        <% end %>
      </div>
    </div>
  </div>
</div>
