<div class="space-y-6">
  <!-- New Token Display (shown only once after creation) -->
  <% if flash[:new_token].present? %>
    <div class="panel border-status-success">
      <div class="panel-header bg-status-success/20">
        <span class="text-status-success">NEW TOKEN GENERATED - COPY NOW</span>
      </div>
      <div class="p-4 space-y-4">
        <div class="bg-dark-base p-4 border border-status-success/50 rounded">
          <div class="flex items-center justify-between">
            <code class="text-status-success font-mono text-sm break-all select-all" id="new-token-value"><%= flash[:new_token] %></code>
            <button onclick="copyToken()" class="ml-4 px-3 py-1 text-xs font-mono uppercase bg-status-success/20 text-status-success border border-status-success/50 hover:bg-status-success/30 transition-colors">
              Copy
            </button>
          </div>
        </div>
        <p class="text-status-warning text-xs font-mono">
          WARNING: This token will not be displayed again. Store it securely.
        </p>
      </div>
    </div>
  <% end %>

  <!-- Create New Token -->
  <div class="panel">
    <div class="panel-header">
      <span>Create New API Token</span>
    </div>
    <div class="p-4">
      <%= form_with model: @new_api_token, url: create_api_token_path, method: :post, class: "space-y-4" do |f| %>
        <% if @new_api_token&.errors&.any? %>
          <div class="bg-status-error/10 border border-status-error/50 p-3 rounded">
            <ul class="list-disc list-inside text-status-error text-sm font-mono">
              <% @new_api_token.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-mono uppercase text-text-muted mb-2">Token Name</label>
            <%= f.text_field :name, class: "input-field w-full", placeholder: "e.g., Cypress Integration" %>
          </div>
          <div>
            <label class="block text-xs font-mono uppercase text-text-muted mb-2">Expiration (Optional)</label>
            <%= f.datetime_local_field :expires_at, class: "input-field w-full" %>
          </div>
        </div>

        <div class="flex justify-end">
          <%= f.submit "Create Token", class: "btn-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Existing Tokens -->
  <div class="panel">
    <div class="panel-header">
      <span>Active API Tokens</span>
      <span class="text-xs text-text-muted"><%= @api_tokens&.count || 0 %> token(s)</span>
    </div>
    <div class="p-4">
      <% if @api_tokens.blank? || @api_tokens.empty? %>
        <div class="text-center py-8">
          <div class="text-text-muted font-mono text-sm">No active tokens</div>
          <div class="text-text-muted/50 font-mono text-xs mt-2">Create a new token to enable API access</div>
        </div>
      <% else %>
        <div class="overflow-x-auto">
          <table class="table-dark w-full">
            <thead>
              <tr>
                <th class="text-left">Name</th>
                <th class="text-left">Token Prefix</th>
                <th class="text-left">Created</th>
                <th class="text-left">Last Used</th>
                <th class="text-left">Expires</th>
                <th class="text-left">Status</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @api_tokens.each do |token| %>
                <tr class="<%= token.expired? ? 'opacity-50' : '' %>">
                  <td class="font-mono text-theme-primary"><%= token.name %></td>
                  <td class="font-mono text-primary"><%= token.token[0..7] %>...</td>
                  <td class="font-mono text-text-muted text-xs"><%= token.created_at.strftime('%Y.%m.%d') %></td>
                  <td class="font-mono text-text-muted text-xs">
                    <%= token.last_used_at ? token.last_used_at.strftime('%Y.%m.%d %H:%M') : 'NEVER' %>
                  </td>
                  <td class="font-mono text-text-muted text-xs">
                    <%= token.expires_at ? token.expires_at.strftime('%Y.%m.%d') : 'PERMANENT' %>
                  </td>
                  <td>
                    <% if token.expired? %>
                      <span class="inline-flex items-center px-2 py-1 text-xs font-mono uppercase bg-status-error/20 text-status-error border border-status-error/30 rounded">
                        EXPIRED
                      </span>
                    <% else %>
                      <span class="inline-flex items-center px-2 py-1 text-xs font-mono uppercase bg-status-success/20 text-status-success border border-status-success/30 rounded">
                        ACTIVE
                      </span>
                    <% end %>
                  </td>
                  <td class="text-right">
                    <%= button_to destroy_api_token_path(token), method: :delete,
                        class: "px-3 py-1 text-xs font-mono uppercase bg-status-error/10 text-status-error border border-status-error/30 hover:bg-status-error/20 transition-colors",
                        data: { turbo_confirm: "Revoke this API token? This action cannot be undone." } do %>
                      Revoke
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Usage Instructions -->
  <div class="panel">
    <div class="panel-header">
      <span>Cypress Integration Guide</span>
    </div>
    <div class="p-4 space-y-4">
      <div class="text-sm font-mono text-text-muted">
        <p class="mb-4">To integrate with Cypress, set the following environment variable:</p>

        <div class="bg-dark-base p-4 border border-primary/30 rounded">
          <code class="text-primary">export MAGI_API_TOKEN=your_token_here</code>
        </div>

        <p class="mt-4 mb-2">Or in your <span class="text-primary">cypress.config.js</span>:</p>

        <div class="bg-dark-base p-4 border border-primary/30 rounded">
          <pre class="text-primary text-xs">module.exports = defineConfig({
  env: {
    MAGI_API_TOKEN: process.env.MAGI_API_TOKEN || 'your_token_here',
    MAGI_API_URL: '<%= request.base_url %>/api/v1'
  }
});</pre>
        </div>

        <p class="mt-4 text-status-warning text-xs">
          NOTE: API tokens provide full access to test run operations. Keep them secure.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
function copyToken() {
  const tokenValue = document.getElementById('new-token-value').textContent;
  navigator.clipboard.writeText(tokenValue).then(() => {
    alert('Token copied to clipboard');
  });
}
</script>
