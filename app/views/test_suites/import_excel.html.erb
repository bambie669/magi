<% content_for :page_title, "IMPORT EXCEL PROTOCOLS" %>

<% content_for :breadcrumbs do %>
  <%= link_to @test_suite.project.name, project_path(@test_suite.project), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <%= link_to @test_suite.name, test_suite_path(@test_suite), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <span class="text-text-muted">Import Excel</span>
<% end %>

<div class="max-w-4xl mx-auto space-y-6">
  <% if @errors.present? %>
    <div class="panel border-status-error/50">
      <div class="panel-header text-status-error">Import Errors Detected</div>
      <div class="p-4">
        <ul class="list-disc list-inside text-sm font-mono text-status-error max-h-48 overflow-y-auto space-y-1">
          <% @errors.each do |error| %>
            <li><%= error %></li>
          <% end %>
        </ul>
        <% if @imported_count && @imported_count > 0 %>
          <p class="mt-4 text-sm font-mono text-status-warning">
            <span class="text-primary"><%= @imported_count %></span> protocols were imported successfully despite the errors.
          </p>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Upload Form -->
  <div class="panel">
    <div class="panel-header flex items-center justify-between">
      <span>IMPORT EXCEL PROTOCOL DATA</span>
      <span class="text-[10px] font-mono text-primary">Bank: <%= @test_suite.name %></span>
    </div>

    <div class="p-6">
      <%= form_with url: process_import_excel_test_suite_path(@test_suite), method: :post, local: true, multipart: true, class: "space-y-6" do |form| %>
        <div>
          <label class="block text-[10px] font-mono text-status-warning uppercase tracking-wider mb-2">Select Excel File</label>
          <div class="relative">
            <input type="file" name="excel_file" accept=".xlsx,.xls" required
              class="input-field w-full px-4 py-3 text-sm file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:font-mono file:uppercase file:tracking-wider file:bg-status-success/20 file:text-status-success hover:file:bg-status-success/30 file:cursor-pointer">
          </div>
          <p class="mt-2 text-[10px] font-mono text-text-muted">Upload an Excel file (.xlsx or .xls) containing protocol data</p>
        </div>

        <div class="flex justify-end space-x-3 pt-6 border-t border-status-error/20">
          <%= link_to 'Abort', test_suite_path(@test_suite), class: "px-4 py-2 bg-dark-surface-mid border border-text-muted-dark text-text-muted text-xs font-mono uppercase tracking-wider hover:text-text-primary transition-colors" %>
          <%= form.submit "Import Data", class: "btn-primary cursor-pointer" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Format Documentation -->
  <div class="panel">
    <div class="panel-header">EXCEL FORMAT SPECIFICATION</div>
    <div class="p-6 space-y-6">
      <p class="text-sm font-mono text-text-primary/80">
        Excel files are imported with each sheet becoming a test scope (folder). Multiple sheets create a structured hierarchy.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-[10px] font-mono text-status-warning uppercase tracking-widest mb-3">Expected Columns</h3>
          <ul class="space-y-2 text-sm font-mono text-text-primary/80">
            <li><span class="text-status-success">Test Case Number</span> - ID (e.g., "1" or "TC 1")</li>
            <li><span class="text-status-success">Test Title</span> - Protocol designation</li>
            <li><span class="text-status-success">Test Steps</span> - Execution steps</li>
            <li><span class="text-status-success">Expected Results</span> - Expected outcome</li>
          </ul>
        </div>

        <div>
          <h3 class="text-[10px] font-mono text-status-warning uppercase tracking-widest mb-3">Optional Columns</h3>
          <ul class="space-y-2 text-sm font-mono text-text-primary/80">
            <li><span class="text-status-success">Prerequisites</span> - Initial conditions</li>
            <li><span class="text-status-success">Actual Results</span> - Ignored during import</li>
            <li><span class="text-status-success">Results</span> - Test status (ignored)</li>
          </ul>
        </div>
      </div>

      <div>
        <h3 class="text-[10px] font-mono text-status-warning uppercase tracking-widest mb-3">Sheet Organization</h3>
        <div class="bg-dark-base/50 border border-status-success/30 p-4">
          <ul class="space-y-2 text-sm font-mono text-text-primary/80">
            <li><span class="text-status-success">Sheet Name</span> becomes the test scope (folder) name</li>
            <li>Section rows (single cell with text) create sub-scopes</li>
            <li>Summary sheets (named "Summary", "Overview", etc.) are skipped</li>
          </ul>
        </div>
      </div>

      <div>
        <h3 class="text-[10px] font-mono text-status-warning uppercase tracking-widest mb-3">Supported Formats</h3>
        <div class="flex space-x-4">
          <div class="px-4 py-2 bg-status-success/10 border border-status-success/30 text-status-success text-sm font-mono">
            .xlsx (Excel 2007+)
          </div>
          <div class="px-4 py-2 bg-status-success/10 border border-status-success/30 text-status-success text-sm font-mono">
            .xls (Legacy Excel)
          </div>
        </div>
      </div>

      <div class="p-4 bg-status-warning/10 border border-status-warning/30">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5 text-status-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="text-sm font-mono text-status-warning">System Note:</span>
        </div>
        <p class="mt-2 text-sm font-mono text-text-primary/80">
          Test scopes will be created automatically based on sheet names. Test case IDs are normalized to "TC" prefix format (e.g., "1" becomes "TC1").
          Duplicate entries (same cypress_id or same title in scope) are automatically skipped.
        </p>
      </div>
    </div>
  </div>
</div>
