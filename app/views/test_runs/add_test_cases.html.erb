<% content_for :page_title, "Add Test Cases" %>

<% content_for :breadcrumbs do %>
  <%= link_to @project.name, project_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-text-muted mx-2">/</span>
  <%= link_to "Test Runs", project_test_runs_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-text-muted mx-2">/</span>
  <%= link_to @test_run.name, test_run_path(@test_run), class: "text-primary hover:text-primary/80" %>
  <span class="text-text-muted mx-2">/</span>
  <span class="text-text-muted">Add Test Cases</span>
<% end %>

<div class="max-w-4xl mx-auto">
  <div class="panel">
    <div class="panel-header flex items-center justify-between">
      <span>Add Test Cases to Operation</span>
      <span class="text-[10px] font-mono text-primary"><%= @test_run.name %></span>
    </div>

    <div class="p-6">
      <%= form_with url: add_test_cases_test_run_path(@test_run), method: :post, class: "space-y-6" do |form| %>
        <div class="p-4 bg-primary/10 border border-primary/30 text-primary font-mono text-sm">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Select test cases to add to this test run. Already included test cases are not shown.</span>
          </div>
        </div>

        <div data-controller="test-case-search">
          <div class="flex items-center justify-between mb-3">
            <p class="text-[10px] font-mono text-text-secondary uppercase tracking-wider">Available Test Cases:</p>
            <div class="flex items-center space-x-2">
              <span data-test-case-search-target="counter" class="text-[10px] font-mono text-text-muted">
                <span data-test-case-search-target="selectedCount">0</span> selected
              </span>
              <% if @available_test_cases.any? %>
                <button type="button" data-action="click->test-case-search#toggleSelectAll" data-test-case-search-target="selectAllBtn" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border border-primary/50 text-primary hover:bg-primary/10 transition-colors">
                  Select All
                </button>
              <% end %>
            </div>
          </div>

          <!-- Search and Filter -->
          <div class="mb-3 space-y-3">
            <input type="text"
                   data-test-case-search-target="searchInput"
                   data-action="input->test-case-search#filter"
                   placeholder="Search by title, ref ID, scope, or cypress ID..."
                   class="input-field w-full px-4 py-2 text-sm">

            <!-- Source Filter Buttons -->
            <div class="flex items-center space-x-2">
              <span class="text-[10px] font-mono text-text-muted uppercase tracking-wider">Source:</span>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="all"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors bg-primary/20 border-primary text-primary">
                All
              </button>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="manual"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors border-text-muted-dark/50 text-text-muted hover:border-primary hover:text-primary">
                Manual
              </button>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="automated"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors border-text-muted-dark/50 text-text-muted hover:border-primary hover:text-primary">
                Automated
              </button>
            </div>

            <p class="text-[10px] font-mono text-text-muted">
              <span data-test-case-search-target="visibleCount"><%= @available_test_cases.count %></span> of <%= @available_test_cases.count %> test cases shown
            </p>
          </div>

          <div class="max-h-96 overflow-y-auto border border-dark-border bg-dark-base/50 p-2 space-y-1" data-test-case-search-target="list">
            <% if @available_test_cases.any? %>
              <% @available_test_cases.group_by { |tc| tc.test_scope }.each do |scope, test_cases| %>
                <div class="mb-2">
                  <div class="px-3 py-1.5 bg-dark-elevated/50 text-[10px] font-mono text-text-muted uppercase tracking-wider sticky top-0">
                    <%= scope&.full_path || 'Uncategorized' %> (<%= test_cases.count %>)
                  </div>
                  <% test_cases.each do |test_case| %>
                    <label class="flex items-center p-2 hover:bg-dark-hover cursor-pointer transition-colors group test-case-item"
                           data-test-case-search-target="item"
                           data-title="<%= test_case.title.downcase %>"
                           data-scope="<%= scope&.full_path&.downcase %>"
                           data-id="<%= test_case.cypress_id&.downcase %>"
                           data-ref="<%= test_case.ref_id&.downcase %>"
                           data-source="<%= test_case.source %>">
                      <%= check_box_tag "test_case_ids[]", test_case.id, false,
                          class: "w-4 h-4 bg-dark-base border-dark-border text-primary focus:ring-primary/50 rounded",
                          data: { action: "change->test-case-search#updateCount", test_case_search_target: "checkbox" } %>
                      <div class="ml-3 flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="px-2 py-0.5 bg-primary/10 border border-primary/30 text-[10px] font-mono text-primary"><%= test_case.ref_id %></span>
                          <% if test_case.cypress_id.present? %>
                            <span class="px-2 py-0.5 bg-status-warning/10 border border-status-warning/30 text-[10px] font-mono text-status-warning uppercase"><%= test_case.cypress_id %></span>
                          <% end %>
                          <span class="text-sm font-mono text-theme-primary group-hover:text-primary transition-colors truncate"><%= test_case.title %></span>
                        </div>
                        <% case test_case.source %>
                        <% when 'manual' %>
                          <span class="text-[9px] font-mono text-text-muted bg-dark-base px-1.5 py-0.5 border border-text-muted/30 uppercase">Manual</span>
                        <% when 'imported' %>
                          <span class="text-[9px] font-mono text-status-success bg-status-success/10 px-1.5 py-0.5 border border-status-success/30 uppercase">Imported</span>
                        <% when 'cypress_auto' %>
                          <span class="text-[9px] font-mono text-status-warning bg-status-warning/10 px-1.5 py-0.5 border border-status-warning/30 uppercase">Cypress</span>
                        <% end %>
                      </div>
                    </label>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-8">
                <svg class="w-12 h-12 mx-auto text-text-muted/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="text-sm font-mono text-text-muted uppercase tracking-wider">All test cases already included</p>
                <p class="text-[10px] font-mono text-text-muted mt-1">This test run contains all available test cases from the project</p>
              </div>
            <% end %>
          </div>

          <!-- No results message -->
          <div data-test-case-search-target="noResults" class="hidden text-center py-4 text-sm font-mono text-text-muted">
            No test cases match your search
          </div>
        </div>

        <div class="flex justify-end space-x-3 pt-6 border-t border-dark-border">
          <%= link_to 'Cancel', test_run_path(@test_run), class: "px-4 py-2 bg-dark-surface border border-dark-border text-text-muted text-xs font-mono uppercase tracking-wider hover:text-theme-primary transition-colors" %>
          <% if @available_test_cases.any? %>
            <%= form.submit "Add Selected Test Cases", class: "btn-primary cursor-pointer" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
