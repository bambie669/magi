<% content_for :page_title, "New Test Run" %>

<% content_for :breadcrumbs do %>
  <%= link_to @project.name, project_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-text-muted mx-2">/</span>
  <%= link_to "Test Runs", project_test_runs_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-text-muted mx-2">/</span>
  <span class="text-text-muted">New</span>
<% end %>

<div class="max-w-4xl mx-auto">
  <div class="panel">
    <div class="panel-header flex items-center justify-between">
      <span>New Test Run</span>
      <span class="text-[10px] font-mono text-primary">Project: <%= @project.name %></span>
    </div>

    <div class="p-6">
      <%= form_with(model: [@project, @test_run], class: "space-y-6") do |form| %>
        <% if @test_run.errors.any? %>
          <div class="p-4 bg-status-error/10 border border-status-error/50 text-status-error font-mono text-sm" role="alert">
            <div class="flex items-center space-x-2 mb-2">
              <span class="w-2 h-2 bg-status-error rounded-full"></span>
              <span class="uppercase tracking-wider text-xs">Validation Error:</span>
            </div>
            <strong class="font-bold"><%= pluralize(@test_run.errors.count, "error") %> prevented this test run from being created:</strong>
            <ul class="mt-2 list-disc list-inside text-sm">
              <% @test_run.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div>
          <%= form.label :name, "Run Name", class: "block text-[10px] font-mono text-text-secondary uppercase tracking-wider mb-2" %>
          <%= form.text_field :name, class: "input-field w-full px-4 py-3 text-sm", placeholder: "Enter test run name..." %>
        </div>

        <div data-controller="test-case-search">
          <div class="flex items-center justify-between mb-3">
            <p class="text-[10px] font-mono text-text-secondary uppercase tracking-wider">Select Test Cases:</p>
            <div class="flex items-center space-x-2">
              <span data-test-case-search-target="counter" class="text-[10px] font-mono text-text-muted">
                <span data-test-case-search-target="selectedCount">0</span> selected
              </span>
              <% if @available_test_cases.any? %>
                <button type="button" data-action="click->test-case-search#toggleSelectAll" data-test-case-search-target="selectAllBtn" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border border-primary/50 text-primary hover:bg-primary/10 transition-colors">
                  Select All
                </button>
              <% end %>
            </div>
          </div>

          <!-- Search and Filter -->
          <div class="mb-3 space-y-3">
            <input type="text"
                   data-test-case-search-target="searchInput"
                   data-action="input->test-case-search#filter"
                   placeholder="Search by title, ref ID, scope, or cypress ID..."
                   class="input-field w-full px-4 py-2 text-sm">

            <!-- Source Filter Buttons -->
            <div class="flex items-center space-x-2">
              <span class="text-[10px] font-mono text-text-muted uppercase tracking-wider">Source:</span>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="all"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors bg-primary/20 border-primary text-primary">
                All
              </button>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="manual"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors border-text-muted-dark/50 text-text-muted hover:border-primary hover:text-primary">
                Manual
              </button>
              <button type="button"
                      data-test-case-search-target="sourceFilter"
                      data-source="automated"
                      data-action="click->test-case-search#filterBySource"
                      class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border transition-colors border-text-muted-dark/50 text-text-muted hover:border-primary hover:text-primary">
                Automated
              </button>
            </div>

            <p class="text-[10px] font-mono text-text-muted">
              <span data-test-case-search-target="visibleCount"><%= @available_test_cases.count %></span> of <%= @available_test_cases.count %> test cases shown
            </p>
          </div>

          <div class="max-h-96 overflow-y-auto border border-dark-border bg-dark-base/50 p-2 space-y-1" data-test-case-search-target="list">
            <% if @available_test_cases.any? %>
              <% @available_test_cases.group_by { |tc| tc.test_scope }.each do |scope, test_cases| %>
                <div class="mb-2">
                  <div class="px-3 py-1.5 bg-dark-elevated/50 text-[10px] font-mono text-text-muted uppercase tracking-wider sticky top-0">
                    <%= scope&.full_path || 'Uncategorized' %> (<%= test_cases.count %>)
                  </div>
                  <% test_cases.each do |test_case| %>
                    <label class="flex items-center p-2 hover:bg-dark-hover cursor-pointer transition-colors group test-case-item"
                           data-test-case-search-target="item"
                           data-title="<%= test_case.title.downcase %>"
                           data-scope="<%= scope&.full_path&.downcase %>"
                           data-id="<%= test_case.cypress_id&.downcase %>"
                           data-ref="<%= test_case.ref_id&.downcase %>"
                           data-source="<%= test_case.source %>">
                      <%= check_box_tag "test_run[test_case_ids][]", test_case.id, false,
                          class: "w-4 h-4 bg-dark-base border-dark-border text-primary focus:ring-primary/50 rounded",
                          data: { action: "change->test-case-search#updateCount", test_case_search_target: "checkbox" } %>
                      <div class="ml-3 flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="px-2 py-0.5 bg-primary/10 border border-primary/30 text-[10px] font-mono text-primary"><%= test_case.ref_id %></span>
                          <% if test_case.cypress_id.present? %>
                            <span class="px-2 py-0.5 bg-status-warning/10 border border-status-warning/30 text-[10px] font-mono text-status-warning uppercase"><%= test_case.cypress_id %></span>
                          <% end %>
                          <span class="text-sm font-mono text-theme-primary group-hover:text-primary transition-colors truncate"><%= test_case.title %></span>
                        </div>
                        <% case test_case.source %>
                        <% when 'manual' %>
                          <span class="text-[9px] font-mono text-text-muted bg-dark-base px-1.5 py-0.5 border border-text-muted/30 uppercase">Manual</span>
                        <% when 'imported' %>
                          <span class="text-[9px] font-mono text-status-success bg-status-success/10 px-1.5 py-0.5 border border-status-success/30 uppercase">Imported</span>
                        <% when 'cypress_auto' %>
                          <span class="text-[9px] font-mono text-status-warning bg-status-warning/10 px-1.5 py-0.5 border border-status-warning/30 uppercase">Cypress</span>
                        <% end %>
                      </div>
                    </label>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-8">
                <p class="text-sm font-mono text-text-muted uppercase tracking-wider">No test cases available</p>
                <p class="text-[10px] font-mono text-text-muted mt-1">Create test cases in a test suite first</p>
              </div>
            <% end %>
          </div>

          <!-- No results message -->
          <div data-test-case-search-target="noResults" class="hidden text-center py-4 text-sm font-mono text-text-muted">
            No test cases match your search
          </div>
        </div>

        <div class="flex justify-end space-x-3 pt-6 border-t border-dark-border">
          <%= link_to 'Cancel', project_path(@project), class: "px-4 py-2 bg-dark-surface border border-dark-border text-text-muted text-xs font-mono uppercase tracking-wider hover:text-theme-primary transition-colors" %>
          <%= form.submit "Create Test Run", class: "btn-primary cursor-pointer" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
