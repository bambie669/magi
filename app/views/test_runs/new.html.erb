<% content_for :page_title, "INITIALIZE OPERATION" %>

<% content_for :breadcrumbs do %>
  <%= link_to @project.name, project_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <%= link_to "Operations", project_test_runs_path(@project), class: "text-primary hover:text-primary/80" %>
  <span class="text-status-error mx-2">/</span>
  <span class="text-text-muted">Initialize</span>
<% end %>

<div class="max-w-4xl mx-auto">
  <div class="panel">
    <div class="panel-header flex items-center justify-between">
      <span>INITIALIZE OPERATION</span>
      <span class="text-[10px] font-mono text-primary">Mission: <%= @project.name %></span>
    </div>

    <div class="p-6">
      <%= form_with(model: [@project, @test_run], class: "space-y-6") do |form| %>
        <% if @test_run.errors.any? %>
          <div class="p-4 bg-status-error/10 border border-status-error/50 text-status-error font-mono text-sm animate-pulse" role="alert">
            <div class="flex items-center space-x-2 mb-2">
              <span class="w-2 h-2 bg-status-error rounded-full"></span>
              <span class="uppercase tracking-wider text-xs">System Error:</span>
            </div>
            <strong class="font-bold"><%= pluralize(@test_run.errors.count, "error") %> prohibited this operation from being initialized:</strong>
            <ul class="mt-2 list-disc list-inside text-sm">
              <% @test_run.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div>
          <%= form.label :name, "Operation Designation", class: "block text-[10px] font-mono text-status-warning uppercase tracking-wider mb-2" %>
          <%= form.text_field :name, class: "input-field w-full px-4 py-3 text-sm", placeholder: "Enter operation designation..." %>
        </div>

        <div>
          <div class="flex items-center justify-between mb-3">
            <p class="text-[10px] font-mono text-status-warning uppercase tracking-wider">Select Protocols to Execute:</p>
            <% if @available_test_cases.any? %>
              <button type="button" id="select-all-btn" onclick="toggleSelectAll()" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wider border border-primary/50 text-primary hover:bg-primary/10 transition-colors">
                Select All
              </button>
            <% end %>
          </div>
          <div class="max-h-80 overflow-y-auto border border-primary/30 bg-dark-base/50 p-4 space-y-2">
            <% if @available_test_cases.any? %>
              <% @available_test_cases.each do |test_case| %>
                <label class="flex items-center p-3 bg-dark-surface-mid border border-text-muted-dark/30 hover:border-primary/50 cursor-pointer transition-colors group">
                  <%= check_box_tag "test_run[test_case_ids][]", test_case.id, false, class: "w-4 h-4 bg-dark-base border-primary/50 text-primary focus:ring-primary/50" %>
                  <span class="ml-3 text-sm font-mono text-text-primary group-hover:text-primary transition-colors"><%= test_case.title %></span>
                </label>
              <% end %>
            <% else %>
              <div class="text-center py-8">
                <p class="text-sm font-mono text-text-muted uppercase tracking-wider">No protocols available in this mission</p>
              </div>
            <% end %>
          </div>
          <p class="mt-2 text-[10px] font-mono text-text-muted">Select protocols to include in this operation</p>
        </div>

        <div class="flex justify-end space-x-3 pt-6 border-t border-status-error/20">
          <%= link_to 'Abort', project_path(@project), class: "px-4 py-2 bg-dark-surface-mid border border-text-muted-dark text-text-muted text-xs font-mono uppercase tracking-wider hover:text-text-primary transition-colors" %>
          <%= form.submit "Initialize Operation", class: "btn-primary cursor-pointer" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('input[name="test_run[test_case_ids][]"]');
    const btn = document.getElementById('select-all-btn');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => cb.checked = !allChecked);
    btn.textContent = allChecked ? 'Select All' : 'Deselect All';
  }
</script>
